<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://distill.pub/template.v1.js"></script>

  <script type="text/front-matter">
    title: "My First Threat Hunt"
    description: "Exploring the fundamentals and common patterns of widget design."
    authors:
    - Luca Vaudano: https://github.com/lucavauda
    affiliations:
    
    date: October 26, 2023 // Optional, but good practice
  </script>

  <title>My First Threat Hunt</title>
</head>
<body>
  <dt-article>
    <h1>My First Threat Hunt</h1>
    <dt-byline></dt-byline>
    <p>One of the things I like doing is reading technical books about various topics. Reading technical books can be challenging because they are not always easy to understand. And what&#39;s more, a good technical book should always have exercises.</p>
<p>Here’s my plan: I want to read and do the work of <a href="https://www.manning.com/books/cyber-threat-hunting"><dt-cite key="AlFardan2025-ix">Cyber Threat Hunting</dt-cite></a>, by Nadhem AlFardan, published by Manning. <a href="https://x.com/karpathy/status/1756380066580455557">Doing the work is essential for learning.</a> I also like to think that learning in public can help. In other words, for each chapter that interests me, I will do an <strong>in-depth technical review</strong> by reviewing and redoing the content proposed in the book, the exercises and adding my consideration.</p>
<p>Also, I will upload each script and file in my <a href="https://github.com/lucavauda/CyberThreatHunting_TechReview/tree/main">repository</a> on GitHub, which is a branch of the original repo containing the necessary files. </p>
<p>I will start from the 3rd chapter called <strong>Your First Threat Hunting Expedition</strong>.  </p>
<h2 id="your-first-threat-hunting-expedition">Your First Threat Hunting Expedition</h2>
<p>Here’s the threat scenario:</p>
<blockquote>
<p>The red team crafted a Microsoft Word document with a suspicious payload and then attached the document to an email they sent to users. Opening the document executes the payload automatically. The code contained in the payload can bypass the existing security controls on the users&#39; machines running Windows 10, going undetected by the anti-virus software. In addition, other security monitoring tools deployed did not generate security alerts for the SOC team to respond to.</p>
</blockquote>
<p><strong>Important note</strong>: In the book, the author will use <strong>Humio</strong> to conduct threat hunting. However, the author notes that other tools like Elastic or Splunk could also be used. I will try to use PowerShell (with the help of Claude).</p>
<p>The raw data is available in this <a href="https://github.com/threat-hunt/data/tree/main/chapter3">public repository</a>. I will upload each script and result in my <a href="https://github.com/lucavauda/CyberThreatHunting_TechReview">personal repository</a>.</p>
<p>The first query (not added here) aims to search for events exhibiting Microsoft Office spawning PowerShell. Here&#39;s the explanation:</p>
<ul>
<li><code>sourcetype=&quot;XmlWinEventLog:Microsoft-Windows-Sysmon/Operational&quot;</code>: Search for Sysmon events only. <code>XmlWinEventLog:Microsoft-Windows-Sysmon/Operational</code> is the sourcetype value assigned to events sent by an agent running on the endpoints and collecting Sysmon events generated by the endpoint.</li>
<li><code>_raw.EventID=1</code>: Search for process creation Sysmon events.</li>
<li><code>_raw.ParentCommandLine=/winword.exe/i</code>: Search for events with parent command line containing the string <code>winword.exe</code>, case insensitive.</li>
<li><code>_raw.CommandLine=/powershell/i</code>: Regex-based and case-insensitive search for events with command line containing powershell.</li>
</ul>
<p>Normally, you would set up multiple queries and test different hypotheses. This particular query returns <strong>zero results</strong>. What to do now? At first, check that the query is correct. If it is, adjust your approach. We recognize that our query is correct but does not produce the outcome we expected, so we can modify our initial hypothesis. Here’s an excerpt from the book:</p>
<blockquote>
<p>Microsoft Office Word spawning a Windows command shell (cmd). The activity maps to MITRE ATT&amp;CK sub-technique T1059.003 &quot;Command and Scripting Interpreter: Windows Command Shell.&quot; In this technique, Microsoft Word did not directly spawn a PowerShell process, but rather PowerShell scripts were created.</p>
</blockquote>
<p>It is possible that an attacker instructed Microsoft Word to write a PowerShell script to disk instead and then got that script executed using other commands or processes. </p>
<p>The first search looks for the following: </p>
<ul>
<li>Sysmon events with <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90011">EventID 11</a> (FileCreate);</li>
<li>Image field containing the string <em>winword</em> (the name of Word process), case insensitive;</li>
<li>TargetFilename field containing the string .ps1, case insensitive.</li>
</ul>
<p>So here’s how to do it in PowerShell:</p>
<dt-code language="powershell">
<pre><code class="lang-powershell"><span class="hljs-comment"># Import your CSV file</span>
<span class="hljs-variable">$events</span> = <span class="hljs-built_in">Import-Csv</span> -Path <span class="hljs-string">"ch3_sysmon_events.csv"</span>

<span class="hljs-comment"># Filter for Event ID 11 (FileCreate) where Word is creating .ps1 files</span>
<span class="hljs-variable">$suspiciousWordPs1</span> = <span class="hljs-variable">$events</span> | <span class="hljs-built_in">Where-Object</span> {
    <span class="hljs-comment"># Match EventID 11</span>
    <span class="hljs-variable">$_</span>.EventID <span class="hljs-nomarkup">-eq</span> <span class="hljs-number">11</span> -and 
    <span class="hljs-comment"># Match Image containing "winword" (case insensitive)</span>
    <span class="hljs-variable">$_</span>.Image <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"winword"</span> -and 
    <span class="hljs-comment"># Match TargetFilename ending with .ps1 (case insensitive)</span>
    <span class="hljs-variable">$_</span>.TargetFilename <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"\.ps1$"</span>
}

<span class="hljs-comment"># Display the results</span>
<span class="hljs-variable">$suspiciousWordPs1</span> | <span class="hljs-built_in">Format-Table</span> -AutoSize

<span class="hljs-comment"># Export to a new CSV</span>
<span class="hljs-variable">$suspiciousWordPs1</span> | <span class="hljs-built_in">Export-Csv</span> -Path <span class="hljs-string">"suspicious_word_ps1.csv"</span> -NoTypeInformation
</code></pre>
</dt-code>
<p>The result of the CSV file (turned into JSON for better viz) is the following:</p>
<pre><code class="lang-json">[
  {
    <span class="hljs-string">"Channel"</span>: <span class="hljs-string">"Microsoft-Windows-Sysmon/Operational"</span>,
    <span class="hljs-string">"CommandLine"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"Computer"</span>: <span class="hljs-string">"DESKTOP-PC01"</span>,
    <span class="hljs-string">"DestinationIp"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"DestinationPort"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"EventID"</span>: <span class="hljs-number">11</span>,
    <span class="hljs-string">"EventRecordID"</span>: <span class="hljs-number">301</span>,
    <span class="hljs-string">"Event{@xmlns}"</span>: <span class="hljs-string">"http://schemas.microsoft.com/win/2004/08/events/event"</span>,
    <span class="hljs-string">"Execution{@ProcessID}"</span>: <span class="hljs-number">1872</span>,
    <span class="hljs-string">"Execution{@ThreadID}"</span>: <span class="hljs-number">3648</span>,
    <span class="hljs-string">"Image"</span>: <span class="hljs-string">"C:\\\\Program Files\\\\Microsoft Office\\\\Office14\\\\WINWORD.EXE"</span>,
    <span class="hljs-string">"Keywords"</span>: <span class="hljs-string">"0x8000000000000000"</span>,
    <span class="hljs-string">"Level"</span>: <span class="hljs-number">4</span>,
    <span class="hljs-string">"Opcode"</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">"ParentCommandLine"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"Protocol"</span>: <span class="hljs-string">""</span>,
    <span class="hljs-string">"Provider{@Guid}"</span>: <span class="hljs-string">"{5770385f-c22a-43e0-bf4c-06f5698ffbd9}"</span>,
    <span class="hljs-string">"Provider{@Name}"</span>: <span class="hljs-string">"Microsoft-Windows-Sysmon"</span>,
    <span class="hljs-string">"Security{@UserID}"</span>: <span class="hljs-string">"S-1-5-18"</span>,
    <span class="hljs-string">"TargetFilename"</span>: <span class="hljs-string">"C:\\\\Users\\\\pc01-user\\\\AppData\\\\Roaming\\\\www.ps1"</span>,
    <span class="hljs-string">"Task"</span>: <span class="hljs-number">11</span>,
    <span class="hljs-string">"TimeCreated"</span>: <span class="hljs-string">"2021-11-21T13:02:28.484734300Z"</span>,
    <span class="hljs-string">"TimeCreated{@SystemTime}"</span>: <span class="hljs-string">"2021-11-21T13:02:28.484734300Z"</span>,
    <span class="hljs-string">"UtcTime"</span>: <span class="hljs-string">"2021-11-21 13:02:28.475"</span>,
    <span class="hljs-string">"Version"</span>: <span class="hljs-number">2</span>,
    ....
      }
  ]
</code></pre>
<p>With a simple query we got a lot of useful information. We know the host name, <strong>DESKTOP-PC01</strong>, which generated the sysmon event. The Sysmon event of type 11 shows that Microsoft Word created a PowerShell script, <code>www.ps1</code>, under Roaming in the AppData folder, a hidden folder by default.</p>
<p>This is the first clue, we also take note of the <em>UtcTime</em>, “2021-11-21 13:02:28.475”, in order to have an event timeline.</p>
<p>After that, we would like to know if the file was accessed or executed by any other process. How can we do it? We can run a free text search for all the file name <code>www.ps1</code> across all Sysmon events for the host name DESKTOP-PC01. Then, to be able to know if perhaps other activities were performed other than creating this file, we could perform a search for <code>winword.exe</code>. </p>
<pre><code class="lang-powershell"><span class="hljs-comment"># Filter for events from the specific hostname containing "www.ps1"</span>
<span class="hljs-variable">$matchingEvents</span> = <span class="hljs-variable">$events</span> | <span class="hljs-built_in">Where-Object</span> {
    <span class="hljs-comment"># Check hostname matches DESKTOP-PC01</span>
    <span class="hljs-variable">$_</span>.Computer <span class="hljs-nomarkup">-eq</span> <span class="hljs-string">"DESKTOP-PC01"</span> -and (
        <span class="hljs-comment"># Check for "www.ps1" in any relevant field that might indicate file access or execution</span>
        <span class="hljs-variable">$_</span>.TargetFilename <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"www\.ps1"</span> -or
        <span class="hljs-variable">$_</span>.Image <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"www\.ps1"</span> -or
        <span class="hljs-variable">$_</span>.CommandLine <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"www\.ps1"</span> -or
        <span class="hljs-variable">$_</span>.ParentCommandLine <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"www\.ps1"</span> -or
        <span class="hljs-variable">$_</span>.SourceFilename <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"www\.ps1"</span> -or
        <span class="hljs-variable">$_</span>.ProcessCommandLine <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"www\.ps1"</span> -or
        <span class="hljs-comment"># Add a general check to catch any other fields</span>
        (<span class="hljs-variable">$_</span> | <span class="hljs-built_in">ConvertTo-Json</span> -Compress) <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"www\.ps1"</span>
    )
}

<span class="hljs-comment"># Display the results and count</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Found $(<span class="hljs-variable">$matchingEvents</span>.Count) events matching the criteria."</span>
&gt;Found <span class="hljs-number">2</span> events matching the criteria.

<span class="hljs-comment"># Group the results by EventID to see what types of events involve this file</span>
<span class="hljs-variable">$eventTypes</span> = <span class="hljs-variable">$matchingEvents</span> | <span class="hljs-built_in">Group-Object</span> -Property EventID | 
    <span class="hljs-built_in">Select-Object</span> @{Name=<span class="hljs-string">"EventID"</span>; Expression={<span class="hljs-variable">$_</span>.Name}}, Count

<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Event types found:"</span>
<span class="hljs-variable">$eventTypes</span> | <span class="hljs-built_in">Format-Table</span> -AutoSize

<span class="hljs-comment"># Display detailed results</span>
<span class="hljs-variable">$matchingEvents</span> | <span class="hljs-built_in">Format-Table</span> EventID, TimeCreated, Computer, Image, CommandLine, TargetFilename -AutoSize

<span class="hljs-comment"># Export results to a new CSV</span>
<span class="hljs-variable">$matchingEvents</span> | <span class="hljs-built_in">Export-Csv</span> -Path <span class="hljs-string">"DESKTOP-PC01_www_ps1_events.csv"</span> -NoTypeInformation
</code></pre>
<p>We found 2 Sysmon events. The results CSV is (only the second one is reported):</p>
<pre><code class="lang-json"> {
    "Channel": "Microsoft-Windows-Sysmon/Operational",
    "CommandLine": "<span class="hljs-symbol">\\</span><span class="hljs-symbol">\"</span><span class="hljs-symbol">\"</span>C:<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>Windows<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>System32<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>WindowsPowerShell<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>v1.0<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>powershell.exe<span class="hljs-symbol">\\</span><span class="hljs-symbol">\"</span><span class="hljs-symbol">\"</span> -ExecutionPolicy  Bypass &amp;amp; C:<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>Users<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>pc01-user<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>AppData<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>Roaming<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>www.ps1",
    "Computer": "DESKTOP-PC01",
    "DestinationIp": "",
    "DestinationPort": "",
    "EventID": 1,
    "EventRecordID": 306,
    "Event{@xmlns}": "http://schemas.microsoft.com/win/2004/08/events/event",
    "Execution{@ProcessID}": 1872,
    "Execution{@ThreadID}": 3648,
    "Image": "C:<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>Windows<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>System32<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>WindowsPowerShell<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>v1.0<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>powershell.exe",
    "Keywords": "0x8000000000000000",
    "Level": 4,
    "Opcode": 0,
    "ParentCommandLine": "<span class="hljs-symbol">\\</span><span class="hljs-symbol">\"</span><span class="hljs-symbol">\"</span>C:<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>Windows<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>System32<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>cscript.exe<span class="hljs-symbol">\\</span><span class="hljs-symbol">\"</span><span class="hljs-symbol">\"</span> C:<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>Users<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>pc01-user<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>AppData<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>Roaming<span class="hljs-symbol">\\</span><span class="hljs-symbol">\\</span>www.txt //E:VBScript //NoLogo <span class="hljs-variable">%~f0 %</span>*",
    "Protocol": "",
    "Provider{@Guid}": "{5770385f-c22a-43e0-bf4c-06f5698ffbd9}",
    "Provider{@Name}": "Microsoft-Windows-Sysmon",
    "Security{@UserID}": "S-1-5-18",
    "TargetFilename": "",
    "Task": 1,
    "TimeCreated": "2021-11-21T13:02:43.173773000Z",
    "TimeCreated{@SystemTime}": "2021-11-21T13:02:43.173773000Z",
    "UtcTime": "2021-11-21 13:02:43.152",
    "Version": 5,
    ...
</code></pre>
<p>This is a sysmon Event of type 1 (process creation) where **<code>www.ps1</code> appears in the CommandLine field containing <code>&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot; -ExecutionPolicy Bypass &amp; C:\Users\pc01-user\AppData\Roaming\www.ps1&quot;</code>.</p>
<p>The event shows <code>powershell.exe</code> executing the script file with <code>-ExecutionPolicy Bypass</code>. Using the Bypass policy means <strong>nothing is blocked</strong>, and no warnings, prompts, or messages will be displayed.</p>
<p>The event also reveals more information. The ParentCommandLine is <code>&quot;C:\Windows\System32\cscript.exe&quot; C:\Users\pc01-user\AppData\Roaming\www.txt //E:VBScript //NoLogo %~f0 %*</code>. We see a new file of interest, <code>www.txt</code>, located in \AppData\Roaming, the same location where <code>winword.exe</code> created <code>www.ps1</code>. More on that later.</p>
<p>The new task would be searching for <em>www.txt</em>, and continue analyzing the value of the ParentCommandLine field.</p>
<p>The <code>cscript.exe</code> process is run with the following parameters:</p>
<ul>
<li><strong>//E:VBScript</strong> specifies VBScript as the scripting engine</li>
<li><strong>//NoLogo</strong> suppresses the banner at startup</li>
<li><strong>%~f0</strong> expands the first argument to cmd %0</li>
<li><strong>%*</strong> expands the rest of the arguments</li>
</ul>
<p>Take a note of the event’s creation time, &quot;UtcTime&quot;: &quot;2021-11-21 13:02:43.152&quot;. The event occurred fifteen seconds after <code>winword.exe</code> created <code>www.ps1</code>.</p>
<p>Here’s the timeline for our DESKTOP-PC01: </p>
<ul>
<li>@13:02:28 **<code>www.ps1</code> created by <code>winword.exe</code></li>
<li>[NEW!] @13:02:43 <code>powershell.exe</code> executed the powershell script <code>www.ps1</code>. The parent process is <code>csscript.exe</code></li>
</ul>
<p>Let’s answer an interesting question: <em>Why a document created a script? Also, was it already there?</em> To answer that, we need a similar query to the one we did before. Let’s search through the Sysmon events for the ones that contains <code>winword.exe</code> with a free text search.</p>
<pre><code class="lang-powershell"><span class="hljs-comment"># Filter for events from DESKTOP-PC01 containing "winword.exe" (case insensitive)</span>
<span class="hljs-comment"># A more strict search in order to restric the results</span>
<span class="hljs-variable">$winwordEventsExact</span> = <span class="hljs-variable">$events</span> | <span class="hljs-built_in">Where-Object</span> {
    <span class="hljs-comment"># Check hostname matches DESKTOP-PC01</span>
    <span class="hljs-variable">$_</span>.Computer <span class="hljs-nomarkup">-eq</span> <span class="hljs-string">"DESKTOP-PC01"</span> -and (
        <span class="hljs-comment"># Look for exact matches in common fields</span>
        <span class="hljs-variable">$_</span>.Image <span class="hljs-nomarkup">-like</span> <span class="hljs-string">"*\winword.exe"</span> -or
        <span class="hljs-variable">$_</span>.ParentImage <span class="hljs-nomarkup">-like</span> <span class="hljs-string">"*\winword.exe"</span> -or
        <span class="hljs-comment"># Command line containing exactly winword.exe (not part of another word)</span>
        <span class="hljs-variable">$_</span>.CommandLine <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"(^|\s)winword\.exe(\s|$)"</span> -or
        <span class="hljs-variable">$_</span>.ParentCommandLine <span class="hljs-nomarkup">-match</span> <span class="hljs-string">"(^|\s)winword\.exe(\s|$)"</span>
    )
}

<span class="hljs-comment"># Display the results and count</span>
<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Found $(<span class="hljs-variable">$winwordEvents</span>.Count) events matching winword.exe on DESKTOP-PC01."</span>
<span class="hljs-comment"># 11 events found</span>

<span class="hljs-comment"># Group the results by EventID to understand the event types</span>
<span class="hljs-variable">$eventTypes</span> = <span class="hljs-variable">$winwordEvents</span> | <span class="hljs-built_in">Group-Object</span> -Property EventID | 
    <span class="hljs-built_in">Select-Object</span> @{Name=<span class="hljs-string">"EventID"</span>; Expression={<span class="hljs-variable">$_</span>.Name}}, Count

<span class="hljs-built_in">Write-Host</span> <span class="hljs-string">"Event types found:"</span>
<span class="hljs-variable">$eventTypes</span> | <span class="hljs-built_in">Format-Table</span> -AutoSize

<span class="hljs-comment"># Display detailed results</span>
<span class="hljs-variable">$winwordEvents</span> | <span class="hljs-built_in">Format-Table</span> EventID, TimeCreated, Computer, Image, CommandLine, ParentImage -AutoSize

<span class="hljs-comment"># Export results to a new CSV</span>
<span class="hljs-variable">$winwordEvents</span> | <span class="hljs-built_in">Export-Csv</span> -Path <span class="hljs-string">"DESKTOP-PC01_winword_events.csv"</span> -NoTypeInformation
</code></pre>
<p>The query above shown 9 results, Claude overspecialized the query in order to trim down the events (the first query I tried there were 11 events). In the book the author presents 8 events matching. Perhaps there are some differences in the query, unfortunately I wasn’t able to find out why. For our intended purposes, we will focus on what the book says.</p>
<p>The search the author got is 8 results, we need to look at the ones before 13:02:28 (the first event in our timeline). By 13:02:17 we notice there’s an interesting log. The first event, in particular is the one we might looking for, is another event with EventID 1, a file creation. We notice that the CommandLine has an indication of the Download folder. The file created is <strong>critical_list.doc</strong>. Let’s update the timeline.</p>
<ul>
<li>@13:02:17 critical_list.doc **opened by <code>winword.exe</code></li>
<li>[NEW!] @13:02:28 <em>*<code>www.ps1</code> created by `</em>winword.exe*`</li>
<li>@13:02:43 <code>powershell.exe</code> executed the powershell script <code>www.ps1</code>. The parent process is <code>csscript.exe</code>.</li>
</ul>
<p>We have this <strong>critical_list.doc</strong> which is interesting. Now let’s discover how did the file make it to the folder. The third results of events is also worth a look. Specifically, there’s a CommanLine field, in which there’s the /Embedding option enabled. This means that macro are enabled after opening the Word file. This third event occurred ad 13:02:19. Let’s update the timeline.</p>
<ul>
<li>@13:02:17 <strong>critical_list.doc</strong> **opened by <code>winword.exe</code></li>
<li>[NEW!] @13:02:19 <code>winword.exe /Embedding</code> command issued</li>
<li>@13:02:28 **<code>www.ps1</code> created by <code>winword.exe</code></li>
<li>@13:02:43 <code>powershell.exe</code> executed the powershell script <code>www.ps1</code>. The parent process is <code>csscript.exe</code>.</li>
</ul>
<p>Have a look at the seventh event from the previous results. The <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90013">EventID is 13</a>, this Registry event type identifies registry value modifications. But the TargetObject field tells us even more: it contains a list of Microsoft Word document file locations for which a user has explicitly enabled editing and macros.</p>
<p>The UtcTime is 13:02:25. So, the timeline updated is: </p>
<ul>
<li>@13:02:17 critical_list.doc **opened by <code>winword.exe</code></li>
<li>@13:02:19 <code>winword.exe /Embedding</code> command issued</li>
<li>[NEW!] @13:02:25 Registry value updated indicating user enabled editing and macros</li>
<li>@13:02:28 **<code>www.ps1</code> created by <code>winword.exe</code></li>
<li>@13:02:43 <code>powershell.exe</code> executed the powershell script <code>www.ps1</code>. The parent process is <code>csscript.exe</code>.</li>
</ul>
<p>What about now? We want to discover when and what created <code>www.txt</code> and how the Word file end up in the machine (and maybe if it got into other machines too). So let’s perform a free text search for <code>www.txt</code> in sysmon events.</p>
<pre><code class="lang-powershell">## Filter <span class="hljs-keyword">for</span> events from DESKTOP-PC01 containing <span class="hljs-string">"www.txt"</span> (<span class="hljs-built_in">case</span> insensitive)
$wwwTxtEvents = $events | <span class="hljs-type">Where</span>-Object {
    # <span class="hljs-keyword">Check</span> hostname matches DESKTOP-PC01
    $<span class="hljs-keyword">_</span>.Computer -eq <span class="hljs-string">"DESKTOP-PC01"</span> -and
    # <span class="hljs-keyword">Check</span> <span class="hljs-keyword">for</span> <span class="hljs-string">"www.txt"</span> <span class="hljs-built_in">in</span> any <span class="hljs-built_in">field</span> (<span class="hljs-built_in">case</span> insensitive)
    ($<span class="hljs-keyword">_</span> | <span class="hljs-type">ConvertTo</span>-Json -Compress) -<span class="hljs-keyword">match</span> <span class="hljs-string">"www\.txt"</span>
}

# Sort events <span class="hljs-built_in">by</span> UtcTime <span class="hljs-built_in">in</span> ascending order
$sortedEvents = $wwwTxtEvents | <span class="hljs-type">Sort</span>-Object -Property UtcTime

# Display the results <span class="hljs-built_in">in</span> a table <span class="hljs-built_in">with</span> the specified fields
$sortedEvents | <span class="hljs-type">Select</span>-Object UtcTime, Computer, EventID, CommandLine, ParentCommandLine | 
    <span class="hljs-type">Format</span>-<span class="hljs-keyword">Table</span> -AutoSize

# <span class="hljs-keyword">Export</span> results to a new CSV
$sortedEvents | <span class="hljs-type">Select</span>-Object UtcTime, Computer, EventID, CommandLine, ParentCommandLine |
    <span class="hljs-type">Export</span>-Csv -<span class="hljs-keyword">Path</span> <span class="hljs-string">"DESKTOP-PC01_www_txt_events.csv"</span> -NoTypeInformation
</code></pre>
<p>The query returns seven results. But none of them are related to creating the <code>www.txt</code>. This is because Sysmon configuration file doesn’t capture file creation of txt files. Not because Sysmon can’t. It <strong>can</strong> log <code>.txt</code> file creation, but it depends on the configuration. The particular configuration file used, the author later showed, that Sysmon creation file events are generated for file with ps1 extension. Sometimes we do not have enough information and that’s OK.</p>
<p>Then the book goes into detail describing each one of the events. Long story short, these log can augment our timeline:</p>
<ul>
<li>@13:02:17 critical_list.doc opened by <code>winword.exe</code></li>
<li>@13:02:19 <code>winword.exe /Embedding</code> command issued</li>
<li>@13:02:25 Registry value updated indicating user enabled editing and macros</li>
<li>@13:02:28 **<code>www.ps1</code> created by <code>winword.exe</code></li>
<li>[NEW!] @13:02:41 **<code>winword.exe</code> executing <code>csscript.exe</code></li>
<li>@13:02:43 <code>powershell.exe</code> executed the powershell script <code>www.ps1</code>. The parent process is <code>csscript.exe</code>.</li>
<li>[NEW!] @13:02:54 **<code>csscript.exe cmd.exe</code> to execute <code>rundll32.exe</code> (4 events)</li>
</ul>
<p>When threat hunting is incredibly simple to get lost in the lots of activities an analyst could/have to do. It is important to <strong>annotate every detail</strong> that could also be useful to the incident response team.</p>
<p>We actually finished the chapter and that’s great. Now let’s get to the exercises in the last pages. Here’s the exercises:</p>
<ol>
<li>Can you find the sysmon network connection events?</li>
<li>What processes initiated the outbound network connections uncovered in question 1?</li>
<li>What were the destination IP addresses and ports for the network connections?</li>
<li>Update the timeline to reflect the new findings.</li>
</ol>
<p>The first one can be solve with a query that searches <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?source=Sysmon&amp;eventID=3">EventID 3</a> and that contains the string “<em>powershell</em>”. Also, the events will be ordered time-wise.</p>
<pre><code class="lang-powershell"># Filter <span class="hljs-keyword">for</span> Sysmon network events (EventID=<span class="hljs-number">3</span>) from DESKTOP-PC01 containing <span class="hljs-string">"powershell"</span> (<span class="hljs-built_in">case</span> insensitive)
$powershellNetworkEvents = $events | <span class="hljs-type">Where</span>-Object {
    # <span class="hljs-keyword">Check</span> hostname matches DESKTOP-PC01
    $<span class="hljs-keyword">_</span>.Computer -eq <span class="hljs-string">"DESKTOP-PC01"</span> -and
    # Match EventID <span class="hljs-number">3</span> (network connection)
    $<span class="hljs-keyword">_</span>.EventID -eq <span class="hljs-number">3</span> -and
    # <span class="hljs-keyword">Check</span> <span class="hljs-keyword">for</span> <span class="hljs-string">"powershell"</span> <span class="hljs-built_in">in</span> any <span class="hljs-built_in">field</span> (<span class="hljs-built_in">case</span> insensitive)
    ($<span class="hljs-keyword">_</span> | <span class="hljs-type">ConvertTo</span>-Json -Compress) -<span class="hljs-keyword">match</span> <span class="hljs-string">"powershell"</span>
}

# Sort events <span class="hljs-built_in">by</span> UtcTime <span class="hljs-built_in">in</span> ascending order
$sortedEvents = $powershellNetworkEvents | <span class="hljs-type">Sort</span>-Object -Property UtcTime

# Display the results <span class="hljs-built_in">in</span> a table <span class="hljs-built_in">with</span> the specified fields
$sortedEvents | <span class="hljs-type">Select</span>-Object UtcTime, DestinationIp, Protocol, DestinationPort, Image | 
    <span class="hljs-type">Format</span>-<span class="hljs-keyword">Table</span> -AutoSize

# <span class="hljs-keyword">Export</span> results to a new CSV
$sortedEvents | <span class="hljs-type">Select</span>-Object UtcTime, DestinationIp, Protocol, DestinationPort, Image |
    <span class="hljs-type">Export</span>-Csv -<span class="hljs-keyword">Path</span> <span class="hljs-string">"DESKTOP-PC01_powershell_network_events.csv"</span> -NoTypeInformation
</code></pre>
<p>The results shows five connection, two from a local IP and three to Internet IP addresses. Here’s the results of the query:</p>
<pre><code class="lang-json">[
  {
    <span class="hljs-attr">"UtcTime"</span>: <span class="hljs-string">"2021-11-21 13:03:03.705"</span>,
    <span class="hljs-attr">"DestinationIp"</span>: <span class="hljs-string">"192.168.155.134"</span>,
    <span class="hljs-attr">"Protocol"</span>: <span class="hljs-string">"tcp"</span>,
    <span class="hljs-attr">"DestinationPort"</span>: <span class="hljs-number">80</span>,
    <span class="hljs-attr">"Image"</span>: <span class="hljs-string">"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"</span>
  },
  {
    <span class="hljs-attr">"UtcTime"</span>: <span class="hljs-string">"2021-11-21 13:03:04.715"</span>,
    <span class="hljs-attr">"DestinationIp"</span>: <span class="hljs-string">"192.168.155.134"</span>,
    <span class="hljs-attr">"Protocol"</span>: <span class="hljs-string">"tcp"</span>,
    <span class="hljs-attr">"DestinationPort"</span>: <span class="hljs-number">80</span>,
    <span class="hljs-attr">"Image"</span>: <span class="hljs-string">"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"</span>
  },
  {
    <span class="hljs-attr">"UtcTime"</span>: <span class="hljs-string">"2021-11-21 13:03:06.225"</span>,
    <span class="hljs-attr">"DestinationIp"</span>: <span class="hljs-string">"146.112.61.110"</span>,
    <span class="hljs-attr">"Protocol"</span>: <span class="hljs-string">"tcp"</span>,
    <span class="hljs-attr">"DestinationPort"</span>: <span class="hljs-number">443</span>,
    <span class="hljs-attr">"Image"</span>: <span class="hljs-string">"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"</span>
  },
  {
    <span class="hljs-attr">"UtcTime"</span>: <span class="hljs-string">"2021-11-21 13:03:06.792"</span>,
    <span class="hljs-attr">"DestinationIp"</span>: <span class="hljs-string">"2.20.7.24"</span>,
    <span class="hljs-attr">"Protocol"</span>: <span class="hljs-string">"tcp"</span>,
    <span class="hljs-attr">"DestinationPort"</span>: <span class="hljs-number">80</span>,
    <span class="hljs-attr">"Image"</span>: <span class="hljs-string">"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"</span>
  },
  {
    <span class="hljs-attr">"UtcTime"</span>: <span class="hljs-string">"2021-11-21 13:03:08.836"</span>,
    <span class="hljs-attr">"DestinationIp"</span>: <span class="hljs-string">"146.112.61.110"</span>,
    <span class="hljs-attr">"Protocol"</span>: <span class="hljs-string">"tcp"</span>,
    <span class="hljs-attr">"DestinationPort"</span>: <span class="hljs-number">443</span>,
    <span class="hljs-attr">"Image"</span>: <span class="hljs-string">"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"</span>
  },
  {
    <span class="hljs-attr">"UtcTime"</span>: <span class="hljs-string">"2021-11-21 13:03:10.545"</span>,
    <span class="hljs-attr">"DestinationIp"</span>: <span class="hljs-string">"146.112.61.110"</span>,
    <span class="hljs-attr">"Protocol"</span>: <span class="hljs-string">"tcp"</span>,
    <span class="hljs-attr">"DestinationPort"</span>: <span class="hljs-number">443</span>,
    <span class="hljs-attr">"Image"</span>: <span class="hljs-string">"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe"</span>
  }
]
</code></pre>
<p>The process <code>powershell.exe</code> initiated the connection.</p>
<p>All outbound connections used TCP port 80 and the IP addresses are:</p>
<ul>
<li>192.168.155.134</li>
<li>2.20.7.24</li>
<li>146.11.61.110</li>
</ul>
<p>The new timeline is:</p>
<ul>
<li>@13:02:17 critical_list.doc **opened by <code>winword.exe</code></li>
<li>@13:02:19 <code>winword.exe /Embedding</code> command issued</li>
<li>@13:02:25 Registry value updated indicating user enabled editing and macros</li>
<li>@13:02:28 **<code>www.ps1</code> created by <code>winword.exe</code></li>
<li>@13:02:41 **<code>winword.exe</code> executing <code>csscript.exe</code></li>
<li>@13:02:43 <code>powershell.exe</code> executed the powershell script <code>www.ps1</code>. The parent process is <code>csscript.exe</code>.</li>
<li>@13:02:54 <code>csscript.exe cmd.exe</code> to execute <code>rundll32.exe</code> (4 events)</li>
<li>[NEW!] @13:03:03 - 13:03:10 <code>powershell.exe</code> initiates connections to internal and external IP addresses (5 events)</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>I learned a lot during this walk through threat hunting exercise. The learning curve for PowerShell query is steep to be honest, but AI Assistants can also help you when stuck. </p>
<p>I really enjoyed writing this, hope it will be useful to someone reading the book, see you soon!</p>

    </dt-article>

  <dt-appendix>
    <h3>References</h3>
    <!-- Bibliography will appear here -->
  </dt-appendix>

  <script type="text/bibliography">
    @book{AlFardan2025-ix,
      title     = "Cyber threat hunting",
      author    = "AlFardan, Nadhem",
      publisher = "Manning Publications",
      month     =  apr,
      year      =  2025,
      address   = "New York, NY",
      language  = "en"
    }
  </script>
</body>
</html>